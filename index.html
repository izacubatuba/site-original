<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Produtos Cadastrados</h1>
        <a href="cadastro_produto.html" class="btn">Cadastrar Novo Produto</a>
    </header>

    <main>
        <!-- Campo de Pesquisa -->
        <input type="text" id="searchInput" placeholder="Pesquisar por nome ou código de barras...">
        
        <div id="productsContainer">
            <!-- Os produtos serão carregados dinamicamente via JavaScript -->
            <p>Carregando produtos...</p>
        </div>
    </main>

    <script>
        // URL correta da API no Fly.io
        const API_URL = "https://minha-api-produto.fly.dev/api";  // Substitua com a URL correta da sua API

        // Função para carregar os produtos da API
        async function carregarProdutos() {
            const container = document.getElementById("productsContainer");
            container.innerHTML = "<p>Carregando produtos...</p>";  // Exibe mensagem enquanto carrega

            try {
                const response = await fetch(`${API_URL}/produtos`);
                if (!response.ok) throw new Error("Erro ao carregar produtos da API");

                const produtos = await response.json();
                console.log(produtos);  // Verifique o que está sendo retornado pela API no console

                if (!Array.isArray(produtos)) throw new Error("Formato de resposta inválido");

                // Salva localmente para uso offline
                localStorage.setItem("produtos", JSON.stringify(produtos));

                renderizarProdutos(produtos);
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);

                // Carregar do LocalStorage se API estiver offline
                const produtosSalvos = localStorage.getItem("produtos");
                if (produtosSalvos) {
                    renderizarProdutos(JSON.parse(produtosSalvos));
                } else {
                    container.innerHTML = "<p>Nenhum produto encontrado.</p>";
                }
            }
        }

        // Função para renderizar os produtos no HTML
        function renderizarProdutos(produtos) {
            const container = document.getElementById("productsContainer");
            container.innerHTML = "";  // Limpa antes de renderizar

            if (produtos.length === 0) {
                container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
                return;
            }

            produtos.forEach(produto => {
                const card = document.createElement("div");
                card.classList.add("product-card");

                card.innerHTML = `
                    <img src="${produto.imagem || 'placeholder.jpg'}" alt="${produto.descricao_produto}">
                    <h3>${produto.descricao_produto}</h3>
                    <p class="codigo-barras">Código: ${produto.cod_barras}</p>
                    <a href="editar_produto.html?codigoBarras=${produto.cod_barras}" class="btn-editar">Editar</a>
                    <a href="#" class="btn-excluir" onclick="confirmarExclusao('${produto.cod_barras}')">Excluir</a>
                `;

                container.appendChild(card);
            });
        }

        // Função de exclusão de produto
        function confirmarExclusao(codigo) {
            if (confirm("Tem certeza que deseja excluir este produto?")) {
                excluirProduto(codigo);
            }
        }

        // Função para excluir um produto
        async function excluirProduto(codigo) {
            let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
            produtos = produtos.filter(produto => produto.cod_barras !== codigo);
            localStorage.setItem("produtos", JSON.stringify(produtos));

            try {
                const response = await fetch(`${API_URL}/produto/${codigo}`, { method: "DELETE" });

                if (!response.ok) throw new Error("Erro ao excluir produto na API");

                alert("Produto excluído com sucesso!");
            } catch (error) {
                console.error("Erro ao excluir produto:", error);
                alert("Produto removido localmente. API indisponível.");
            }

            carregarProdutos();  // Atualiza a lista após exclusão
        }

        // Função de busca de produtos por nome ou código de barras
        document.getElementById("searchInput").addEventListener("input", function () {
            const termoPesquisa = this.value.toLowerCase();
            const produtos = document.querySelectorAll(".product-card");

            let produtosVisiveis = 0;

            produtos.forEach(produto => {
                const nomeProduto = produto.querySelector("h3").textContent.toLowerCase();
                const codigoBarras = produto.querySelector(".codigo-barras").textContent.toLowerCase();

                if (nomeProduto.includes(termoPesquisa) || codigoBarras.includes(termoPesquisa)) {
                    produto.style.display = "block";
                    produtosVisiveis++;
                } else {
                    produto.style.display = "none";
                }
            });

            const container = document.getElementById("productsContainer");
            if (produtosVisiveis === 0) {
                container.innerHTML = "<p>Nenhum produto encontrado.</p>";
            }
        });

        // Chama a função para carregar os produtos assim que a página carregar
        window.onload = carregarProdutos;
    </script>
</body>
</html>
